api_version: azuresre.ai/v2
kind: ExtendedAgentTool
metadata:
  name: PrivateLAW_QueryLogs
  tags:
    - ampls
    - private-link
    - easy-auth
spec:
  type: PythonTool
  toolMode: Auto
  description: Execute KQL queries against a private Log Analytics workspace via AMPLS using Easy Auth (Entra ID)
  functionCode: |
    import json
    import urllib.request
    import urllib.error
    import os

    def main(**kwargs):
        query = kwargs.get('query', '')
        timespan = kwargs.get('timespan', 'P1D')

        if not query:
            return {"error": "Query parameter is required"}

        function_url = 'https://func-law-query-easyauth-test.azurewebsites.net/api/query_logs'
        app_id = 'b7d37e65-5fcc-4589-a614-21d2c67ae275'

        # Acquire token from managed identity endpoint
        identity_endpoint = os.environ.get('IDENTITY_ENDPOINT', '')
        identity_header = os.environ.get('IDENTITY_HEADER', '')

        if not identity_endpoint or not identity_header:
            return {"error": "Managed identity not available. IDENTITY_ENDPOINT or IDENTITY_HEADER not set."}

        token_url = f"{identity_endpoint}?api-version=2019-08-01&resource=api://{app_id}"
        token_req = urllib.request.Request(token_url)
        token_req.add_header('X-IDENTITY-HEADER', identity_header)

        try:
            with urllib.request.urlopen(token_req, timeout=10) as token_resp:
                token_data = json.loads(token_resp.read().decode('utf-8'))
                access_token = token_data.get('access_token', '')
        except Exception as e:
            return {"error": f"Failed to acquire token: {str(e)}"}

        if not access_token:
            return {"error": "Failed to acquire access token"}

        headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {access_token}'
        }
        body = json.dumps({'query': query, 'timespan': timespan}).encode('utf-8')

        try:
            req = urllib.request.Request(function_url, data=body, headers=headers, method='POST')
            with urllib.request.urlopen(req, timeout=60) as response:
                return json.loads(response.read().decode('utf-8'))
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            return {"error": f"HTTP {e.code}: {error_body}", "status": "failed"}
        except Exception as e:
            return {"error": f"Unexpected error: {str(e)}", "status": "failed"}
  parameters:
    - name: query
      type: string
      description: The KQL query to execute
      required: true
    - name: timespan
      type: string
      description: ISO 8601 duration (PT1H, P1D, P7D)
      required: false
